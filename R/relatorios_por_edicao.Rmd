---
title: "`r params$title`"
output: 
  html_document:
    theme: null
    self_contained: false
params:
  file_path: 'I:/.shortcut-targets-by-id/15QBAXOC5TdfNgOtQZh2jvqN37NjxkSM0/@BICI/06_Eixo Dados/Projetos/Papo de pedal/Edicao 270325/result/pesquisa_papo_pedal.rds'
  title: 'Edição 25/10/2025'
includes:
  in_header:
    style.css
    actions.js
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE,message = FALSE)
library(tidyverse)
library(data.table)
library(plotly)
library(leaflet)
library(htmltools)
library(htmlwidgets)
```




```{r data, warning=FALSE,message=FALSE}

df <- readRDS(params$file_path)


```


<div class="fullcontainer" style="width:100%;display:flex;position:relative;
flex-wrap:wrap;gap:0px;">

<style>
h1.title.toc-ignore{
  visibility: hidden;
  height: 0px;
  width: 0px;
  margin: 0;
}
</style>

<div class="leftcol" style="width:29%;flex: 3 1 250px; position:relative;display:block;">

```{r whitediv, warning=FALSE,message=FALSE}

tags$div(style = "width:100%;min-height:60px;display:block;background-color:white")


```


```{r idade,  warning=FALSE,message=FALSE}

p <- df %>% 
  select(idade) %>% 
  mutate(idade = as.numeric(idade)) %>% 
  filter(!is.na(idade)) %>% 
  filter(idade!='') %>% 
  mutate(Idade_lbl = cut(idade,c(seq(0,80,10),100))) %>% 
  group_by(Idade_lbl) %>% 
  reframe(n = n()) %>% 
  mutate(perc = scales::percent(n/sum(n),.1)) %>% 
  plot_ly(
    x = ~Idade_lbl,
    y = ~n,
    type = "bar",
    text = ~perc,
    name = "Idade dos respondentes",
    marker = list(
      color = "#009889",
      line = list(color = "#325565",width = 1)
    )
  ) %>% 
  layout(
    title = "Idade dos respondentes",
    xaxis = list(title = "Idade"),
    yaxis = list(title = "Contagem")
  )

tags$div(
  style = "position:relative; width:100%;",
  p
)

```

</div>

<div class="rightcol" style="width:70%;flex: 6 1 600px; position:relative;display:flex;">

```{r motivo_escolha,  warning=FALSE,message=FALSE}

df2 <- df %>% 
  pull(por_que_escolheu_ou_escolhe_andar_de_bicicleta_agrupado) %>% 
  str_split(';') %>% 
  unlist() %>% 
  str_trim() %>% 
  table() %>% 
  as_tibble() %>% 
  setNames(c('value','n')) %>% 
  mutate(base = 2) %>% 
  arrange(-n) %>% 
  mutate(theta = seq(0,360,trunc(360/n()))[1:n()]) %>% 
  mutate(perc = scales::percent(n/sum(n),.1))

p <- plot_ly(
    data = df2,
    type = "barpolar",
    visible = TRUE,
    r = ~n,
    theta = ~theta,
    base = ~base,
    marker = list(
      color = "#009889",
      line = list(color = "white", width = 2)
    ),
    hovertemplate = "%{text}: %{r}<extra></extra>",
    text = ~value
  ) %>% 
  layout(
    showlegend = FALSE,
    title = "Motivo da escolha da bicicleta",
    polar = list(
      angularaxis = list(
        tickvals = df2$theta,
        tickmode = "array",
        ticktext = str_wrap(df2$value,13),
        tickfont = list(
          family = "Montserrat",
          color = 'black'
        ),
        rotation = 90,
        gridcolor = '#e0e0e0',
        showline = F
      ),
      radialaxis = list(visible = FALSE)
    ),
    margin = list(l = 90, r = 90, t = 90, b = 70)
  )

tags$div(
  style = "position:relative; width:55%;",
  tags$h3("Principal problema enfrentado"),
  p
)

```


```{r problemas,  warning=FALSE,message=FALSE}

p <- df %>% 
  pull(qual_e_o_principal_problema_que_voce_enfrenta_ao_andar_de_bicicleta_em_fortaleza_agrupado) %>% 
  str_split(";") %>% 
  unlist() %>% 
  str_trim() %>% 
  str_split(",") %>% 
  unlist() %>% 
  str_trim() %>% 
  table() %>% 
  as_tibble() %>% 
  setNames(c("value","n")) %>% 
  mutate(perc = n/sum(n)) %>% 
  arrange(-n)

if(any(p$perc<0.02)){
  p <- p %>% 
    filter(perc>=0.02)
  p <- bind_rows(
    p,
    tibble(
      value = "Outros",
      perc = 1-sum(p$perc)
    )
  )
}

p <- apply(p, 1, function(x){
  perc <- as.numeric(x["perc"])
  tags$div(
    class = "kpi",
    style = paste0("--p:",trunc(perc*100),";",
                   "--c:#F15A22;"),
    tags$div(
      class = "donut",
      tags$span(
        scales::percent(perc,.1)
      ),
      tags$div(
        class = "lbl",
        x["value"]
      )
    )
  )
})

s <- HTML(read_lines("../css/style_donut.css")) %>% tags$style()

tags$div(
  style = "position:relative; width:45%;",
  tags$div(
    class = "grid",
    p,
    s
  )
)

```

</div>

</div>


<div class="fullcontainer" style="width:100%;display:flex;position:relative;">

<h2>Segunda Linha</h2>

</div>